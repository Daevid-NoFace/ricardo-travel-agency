---
import ExperienceCard from './ExperienceCard.astro';
import { getExperiences } from '../../data/experiences';
import { getLangFromUrl, useTranslations } from '../i18n/utils';

const currentLang = getLangFromUrl(Astro.url);
const t = useTranslations(currentLang);
const experiences = getExperiences(currentLang).slice(0, 5);
---

<section id="experiences" class="py-20 bg-gradient-to-b from-sand/20 to-white">
  <div class="container mx-auto px-4">
    <!-- Section Header -->
    <div class="text-center mb-16 max-w-3xl mx-auto">
      <span class="text-coral font-semibold text-sm uppercase tracking-wider mb-4 block">{t('experiences.label')}</span>
      <h2 class="text-4xl md:text-5xl font-bold text-gray-900 mb-6">
        {t('experiences.title')} <span class="text-caribbean-blue">{t('experiences.titleHighlight')}</span>
      </h2>
      <p class="text-lg text-gray-700 leading-relaxed">
        {t('experiences.subtitle')}
      </p>
    </div>

    <!-- Experience Cards Carousel -->
    <div class="relative max-w-7xl mx-auto">
      
      <!-- Botón anterior -->
      <button 
        id="carousel-prev"
        class="absolute left-4 top-1/2 -translate-y-1/2 z-20 w-12 h-12 bg-white/90 hover:bg-white rounded-full shadow-lg flex items-center justify-center transition-all duration-300 hover:scale-110"
        aria-label="Anterior"
      >
        <svg class="w-6 h-6 text-caribbean-blue" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M15 19l-7-7 7-7"/>
        </svg>
      </button>
      
      <!-- Botón siguiente -->
      <button 
        id="carousel-next"
        class="absolute right-4 top-1/2 -translate-y-1/2 z-20 w-12 h-12 bg-white/90 hover:bg-white rounded-full shadow-lg flex items-center justify-center transition-all duration-300 hover:scale-110"
        aria-label="Siguiente"
      >
        <svg class="w-6 h-6 text-caribbean-blue" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M9 5l7 7-7 7"/>
        </svg>
      </button>
      
      <!-- Contenedor del carrusel -->
      <div class="overflow-hidden px-4">
        <div id="experiences-carousel" class="flex gap-8 transition-transform duration-500 ease-out">
          {experiences.map((experience) => (
            <div class="flex-shrink-0 w-full md:w-[calc(50%-1rem)] lg:w-[calc(33.333%-1.333rem)]">
              <ExperienceCard {...experience} />
            </div>
          ))}
          <!-- Duplicar experiencias para efecto infinito -->
          {experiences.map((experience) => (
            <div class="flex-shrink-0 w-full md:w-[calc(50%-1rem)] lg:w-[calc(33.333%-1.333rem)]">
              <ExperienceCard {...experience} />
            </div>
          ))}
        </div>
      </div>
      
      <!-- Indicadores -->
      <div class="flex justify-center gap-2 mt-8">
        {experiences.map((_, index) => (
          <button 
            class="carousel-indicator w-2 h-2 rounded-full bg-gray-300 hover:bg-caribbean-blue transition-colors duration-300"
            data-index={index}
            aria-label={`Ir a experiencia ${index + 1}`}
          ></button>
        ))}
      </div>
    </div>

    <!-- CTA -->
    <div class="text-center mt-24">
      <p class="text-lg text-gray-700 mb-6">
        {t('experiences.ctaQuestion')}
      </p>
      <a 
        href="#contact" 
        class="inline-block px-8 py-4 bg-coral text-white rounded-lg font-semibold text-lg hover:bg-sunset-orange transition-all duration-300 transform hover:scale-105 shadow-lg"
      >
        <span>{t('experiences.ctaButton')}</span>
      </a>
    </div>
  </div>
</section>

<script>
  // Carrusel infinito de experiencias
  function initCarousel() {
    const carousel = document.getElementById('experiences-carousel');
    const prevBtn = document.getElementById('carousel-prev');
    const nextBtn = document.getElementById('carousel-next');
    const indicators = document.querySelectorAll('.carousel-indicator');
    
    if (!carousel) return;
    
    const cards = carousel.children;
    const totalCards = cards.length / 2; // Dividido por 2 porque duplicamos las cards
    let currentIndex = 0;
    let isTransitioning = false;
    let autoplayInterval: number;
  
  // Calcular cuántas cards mostrar según el ancho de pantalla
  const getCardsPerView = () => {
    const width = window.innerWidth;
    if (width >= 1024) return 3; // Desktop: 3 cards
    if (width >= 768) return 2;  // Tablet: 2 cards
    return 1;                     // Mobile: 1 card
  };
  
  // Calcular el desplazamiento
  const getCardWidth = () => {
    const firstCard = cards[0] as HTMLElement;
    return firstCard.offsetWidth + 32; // card width + gap
  };
  
  // Actualizar posición del carrusel
  const updateCarousel = (smooth = true) => {
    if (!carousel) return;
    
    const cardWidth = getCardWidth();
    const offset = -currentIndex * cardWidth;
    
    carousel.style.transition = smooth ? 'transform 0.5s ease-out' : 'none';
    carousel.style.transform = `translateX(${offset}px)`;
    
    // Actualizar indicadores
    indicators.forEach((indicator, index) => {
      if (index === currentIndex % totalCards) {
        indicator.classList.add('bg-caribbean-blue');
        indicator.classList.remove('bg-gray-300');
      } else {
        indicator.classList.remove('bg-caribbean-blue');
        indicator.classList.add('bg-gray-300');
      }
    });
  };
  
  // Navegar al siguiente
  const goToNext = () => {
    if (isTransitioning) return;
    isTransitioning = true;
    
    currentIndex++;
    updateCarousel();
    
    // Si llegamos al final de las cards duplicadas, volver al inicio sin animación
    setTimeout(() => {
      if (currentIndex >= totalCards) {
        currentIndex = 0;
        updateCarousel(false);
      }
      isTransitioning = false;
    }, 500);
  };
  
  // Navegar al anterior
  const goToPrev = () => {
    if (isTransitioning) return;
    isTransitioning = true;
    
    // Si estamos al inicio, saltar al final sin animación
    if (currentIndex === 0) {
      currentIndex = totalCards;
      updateCarousel(false);
      
      setTimeout(() => {
        currentIndex--;
        updateCarousel();
        setTimeout(() => {
          isTransitioning = false;
        }, 500);
      }, 50);
    } else {
      currentIndex--;
      updateCarousel();
      setTimeout(() => {
        isTransitioning = false;
      }, 500);
    }
  };
  
  // Ir a un índice específico
  const goToIndex = (index: number) => {
    if (isTransitioning) return;
    currentIndex = index;
    updateCarousel();
  };
  
  // Autoplay
  const startAutoplay = () => {
    autoplayInterval = setInterval(goToNext, 5000) as unknown as number;
  };
  
  const stopAutoplay = () => {
    clearInterval(autoplayInterval);
  };
  
  // Event listeners
  nextBtn?.addEventListener('click', () => {
    stopAutoplay();
    goToNext();
    startAutoplay();
  });
  
  prevBtn?.addEventListener('click', () => {
    stopAutoplay();
    goToPrev();
    startAutoplay();
  });
  
  indicators.forEach((indicator, index) => {
    indicator.addEventListener('click', () => {
      stopAutoplay();
      goToIndex(index);
      startAutoplay();
    });
  });
  
  // Pausar autoplay al hover
  carousel?.addEventListener('mouseenter', stopAutoplay);
  carousel?.addEventListener('mouseleave', startAutoplay);
  
  // Soporte táctil para swipe
  let touchStartX = 0;
  let touchEndX = 0;
  
  carousel?.addEventListener('touchstart', (e) => {
    touchStartX = e.touches[0].clientX;
    stopAutoplay();
  });
  
  carousel?.addEventListener('touchmove', (e) => {
    touchEndX = e.touches[0].clientX;
  });
  
  carousel?.addEventListener('touchend', () => {
    const swipeThreshold = 50;
    const diff = touchStartX - touchEndX;
    
    if (Math.abs(diff) > swipeThreshold) {
      if (diff > 0) {
        goToNext();
      } else {
        goToPrev();
      }
    }
    startAutoplay();
  });
  
    // Recalcular en resize
    window.addEventListener('resize', () => {
      updateCarousel(false);
    });
    
    // Inicializar
    updateCarousel(false);
    startAutoplay();
  }
  
  // Variable global para el intervalo
  let globalAutoplayInterval: number | undefined;
  
  // Limpiar intervalo anterior si existe
  function cleanupCarousel() {
    if (globalAutoplayInterval) {
      clearInterval(globalAutoplayInterval);
      globalAutoplayInterval = undefined;
    }
  }
  
  // Wrapper para inicializar con limpieza
  function initCarouselWithCleanup() {
    cleanupCarousel();
    initCarousel();
  }
  
  // Inicializar en carga de página
  document.addEventListener('DOMContentLoaded', initCarouselWithCleanup);
  
  // Reinicializar después de navegación de Astro
  document.addEventListener('astro:page-load', initCarouselWithCleanup);
  
  // Limpiar antes de salir de la página
  document.addEventListener('astro:before-preparation', cleanupCarousel);
</script>