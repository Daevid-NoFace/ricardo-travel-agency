---
import { getLangFromUrl, useTranslations } from '../i18n/utils';
import GalleryCarousel from '../GalleryCarousel';

const currentLang = getLangFromUrl(Astro.url);
const t = useTranslations(currentLang);
const rawGalleryItems = t('gallery.items');
const galleryItems: Array<{ title: string; description: string }> = Array.isArray(rawGalleryItems)
  ? (rawGalleryItems as Array<{ title: string; description: string }>).map((item) => ({
      title: item.title,
      description: item.description
    }))
  : [];

const UNSPLASH_ACCESS_KEY = import.meta.env.UNSPLASH_ACCESS_KEY;

// Cuba-related search queries for each gallery item
const cubaSearchQueries = [
  'havana cuba colorful',
  'classic car cuba',
  'caribbean beach',
  'tobacco field',
  'cuban music',
  'colonial street cuba',
  'havana sunset',
  'cuban food',
  'colonial architecture',
  'tropical beach',
  'salsa dance',
  'valley landscape'
];

// Fetch photos from Unsplash API
const fetchUnsplashPhoto = async (query: string, index: number) => {
  // Fallback colors for placeholders
  const colors = ['FF6B6B', '4ECDC4', '45B7D1', 'FFA07A', '98D8C8', 'F7DC6F', 'BB8FCE', '85C1E2', 'F8B739', 'EC7063', '52B788', 'F4A261'];
  const color = colors[index % colors.length];
  
  // If no API key, use placeholder immediately
  if (!UNSPLASH_ACCESS_KEY) {
    console.warn('No Unsplash API key found, using placeholder');
    return {
      url: `https://placehold.co/800x800/${color}/FFFFFF?text=${encodeURIComponent('Cuba')}`,
      thumb: `https://placehold.co/400x400/${color}/FFFFFF?text=${encodeURIComponent('Cuba')}`,
      alt: query,
      photographer: 'Placeholder',
      photographerUrl: '#'
    };
  }

  try {
    const searchResponse = await fetch(
      `https://api.unsplash.com/search/photos?query=${encodeURIComponent(query)}&per_page=1`,
      {
        headers: {
          'Authorization': `Client-ID ${UNSPLASH_ACCESS_KEY}`
        }
      }
    );

    if (!searchResponse.ok) {
      const errorText = await searchResponse.text();
      console.error(`Unsplash API error for "${query}": ${searchResponse.status} - ${errorText}`);
      throw new Error(`API error: ${searchResponse.status}`);
    }

    const searchData = await searchResponse.json();
    
    if (searchData.results && searchData.results.length > 0) {
      const photo = searchData.results[0];
      console.log(`âœ“ Found photo for "${query}"`);
      return {
        url: photo.urls.regular,
        thumb: photo.urls.small,
        alt: photo.alt_description || query,
        photographer: photo.user.name,
        photographerUrl: photo.user.links.html
      };
    } else {
      console.warn(`No results for "${query}", using placeholder`);
      throw new Error('No photos found');
    }
  } catch (error) {
    // Fallback to placeholder
    return {
      url: `https://placehold.co/800x800/${color}/FFFFFF?text=${encodeURIComponent('Cuba')}`,
      thumb: `https://placehold.co/400x400/${color}/FFFFFF?text=${encodeURIComponent('Cuba')}`,
      alt: query,
      photographer: 'Placeholder',
      photographerUrl: '#'
    };
  }
};

// Fetch all photos
const galleryPhotos = await Promise.all(
  galleryItems.map((item, index) => 
    fetchUnsplashPhoto(cubaSearchQueries[index % cubaSearchQueries.length], index)
  )
);
---

<section id="gallery" class="py-20 bg-white">
  <div class="container mx-auto px-4">
    <!-- Section Header -->
    <div class="text-center mb-16 max-w-3xl mx-auto">
      <span class="text-coral font-semibold text-sm uppercase tracking-wider mb-4 block">{t('gallery.label')}</span>
      <h2 class="text-4xl md:text-5xl font-bold text-gray-900 mb-6">
        {t('gallery.title')} <span class="text-caribbean-blue">{t('gallery.titleHighlight')}</span>
      </h2>
      <p class="text-lg text-gray-700 leading-relaxed">
        {t('gallery.subtitle')}
      </p>
    </div>

    <!-- Gallery Carousel -->
    <GalleryCarousel 
      client:load
      photos={galleryPhotos}
      items={galleryItems}
    />
  </div>
</section>