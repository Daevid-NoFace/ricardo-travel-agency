---
import ExperienceCard from './ExperienceCard.astro';
import { experiences } from '../../data/experiences';
import { getI18n } from '../i18n';

// Default to Spanish for SSG
const t = getI18n({ currentLocale: 'es' });
---

<section id="experiences" class="py-20 bg-gradient-to-b from-sand/20 to-white">
  <div class="container mx-auto px-4">
    <!-- Section Header -->
    <div class="text-center mb-16 max-w-3xl mx-auto">
      <span class="text-coral font-semibold text-sm uppercase tracking-wider mb-4 block" data-i18n="experiences.label">{t.experiences.label}</span>
      <h2 class="text-4xl md:text-5xl font-bold text-gray-900 mb-6">
        <span data-i18n="experiences.title">{t.experiences.title}</span> <span class="text-caribbean-blue" data-i18n="experiences.titleHighlight">{t.experiences.titleHighlight}</span>
      </h2>
      <p class="text-lg text-gray-700 leading-relaxed" data-i18n="experiences.subtitle">
        {t.experiences.subtitle}
      </p>
    </div>

    <!-- Experience Cards Grid -->
    <div class="relative max-w-7xl mx-auto">
      <div id="experiences-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8 overflow-hidden transition-all duration-500" style="max-height: 1000px;">
        {experiences.map((experience) => (
          <ExperienceCard {...experience} />
        ))}
      </div>
      
      <!-- Gradiente y botón de expansión -->
      <div id="expand-overlay" class="absolute bottom-0 left-0 right-0 h-10 bg-gradient-to-t from-white via-white/90 to-transparent pointer-events-none transition-opacity duration-300">
        <div class="absolute bottom-[-70px] left-1/2 -translate-x-1/2 pointer-events-auto">
          <button 
            id="toggle-experiences"
            class="group flex items-center gap-2 px-8 py-4 bg-caribbean-blue text-white rounded-full font-semibold text-lg hover:bg-ocean-blue transition-all duration-300 transform hover:scale-105 shadow-xl"
            aria-label="Ver más experiencias"
          >
            <span id="toggle-text">{t.experiences.showMore}</span>
            <svg id="toggle-arrow" class="w-6 h-6 transition-transform duration-300 group-hover:translate-y-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M19 9l-7 7-7-7"/>
            </svg>
          </button>
        </div>
      </div>
    </div>

    <!-- CTA -->
    <div class="text-center mt-24">
      <p class="text-lg text-gray-700 mb-6" data-i18n="experiences.ctaQuestion">
        {t.experiences.ctaQuestion}
      </p>
      <a 
        href="#contact" 
        class="inline-block px-8 py-4 bg-coral text-white rounded-lg font-semibold text-lg hover:bg-sunset-orange transition-all duration-300 transform hover:scale-105 shadow-lg"
      >
        <span data-i18n="experiences.ctaButton">{t.experiences.ctaButton}</span>
      </a>
    </div>
  </div>
</section>

<script>
  // Get translations based on current language
  const getTranslations = () => {
    const lang = localStorage.getItem('language') || 'es';
    const translations = {
      es: { showMore: 'Ver más experiencias', showLess: 'Ver menos' },
      en: { showMore: 'Show more experiences', showLess: 'Show less' },
      pt: { showMore: 'Ver mais experiências', showLess: 'Ver menos' }
    };
    return translations[lang as keyof typeof translations] || translations.es;
  };

  // Toggle para expandir/colapsar experiencias
  const grid = document.getElementById('experiences-grid');
  const overlay = document.getElementById('expand-overlay');
  const toggleBtn = document.getElementById('toggle-experiences');
  const toggleText = document.getElementById('toggle-text');
  const toggleArrow = document.getElementById('toggle-arrow');
  
  let isExpanded = false;
  const t = getTranslations();
  
  // Calcular altura inicial para mostrar solo 3 cards
  const calculateCollapsedHeight = () => {
    if (!grid) return;
    const cards = grid.children;
    if (cards.length === 0) return;
    
    // Obtener altura de una card + gap
    const firstCard = cards[0] as HTMLElement;
    const cardHeight = firstCard.offsetHeight;
    const gap = 32; // 8 * 4px (gap-8 de Tailwind)
    
    // En móvil (1 columna): 3 cards
    // En tablet (2 columnas): 2 filas = 4 cards
    // En desktop (3 columnas): 1 fila = 3 cards
    const width = window.innerWidth;
    let rows = 3;
    
    if (width >= 1024) {
      rows = 1; // 3 cards en 1 fila
    } else if (width >= 768) {
      rows = 2; // 4 cards en 2 filas
    }
    
    const collapsedHeight = (cardHeight * rows) + (gap * (rows - 1));
    grid.style.maxHeight = `${collapsedHeight}px`;
  };
  
  // Inicializar altura colapsada
  calculateCollapsedHeight();
  
  // Recalcular en resize
  window.addEventListener('resize', () => {
    if (!isExpanded) {
      calculateCollapsedHeight();
    }
  });
  
  // Update text on language change
  window.addEventListener('languageChange', () => {
    const newT = getTranslations();
    if (toggleText) {
      toggleText.textContent = isExpanded ? newT.showLess : newT.showMore;
    }
  });

  // Toggle al hacer clic
  toggleBtn?.addEventListener('click', () => {
    isExpanded = !isExpanded;
    
    if (isExpanded) {
      // Expandir
      grid!.style.maxHeight = `${grid!.scrollHeight}px`;
      overlay!.style.opacity = '0';
      toggleText!.textContent = t.showLess;
      toggleArrow!.style.transform = 'rotate(180deg)';
      
      // Ocultar overlay después de la animación
      setTimeout(() => {
        overlay!.style.display = 'none';
      }, 300);
    } else {
      // Colapsar
      overlay!.style.display = 'block';
      setTimeout(() => {
        overlay!.style.opacity = '1';
      }, 10);
      calculateCollapsedHeight();
      toggleText!.textContent = t.showMore;
      toggleArrow!.style.transform = 'rotate(0deg)';
      
      // Scroll suave hacia la sección
      document.getElementById('experiences')?.scrollIntoView({ 
        behavior: 'smooth', 
        block: 'start' 
      });
    }
  });

  // Update all data-i18n elements in experiences section
  import { getI18n } from '../i18n';
  
  function updateExperiencesText() {
    const lang = localStorage.getItem('language') || 'es';
    const translations = getI18n({ currentLocale: lang });
    
    document.querySelectorAll('#experiences [data-i18n]').forEach((el) => {
      const key = el.getAttribute('data-i18n');
      if (key) {
        const keys = key.split('.');
        let value: any = translations;
        for (const k of keys) {
          value = value?.[k];
        }
        if (value && el.textContent !== value) {
          el.textContent = value;
        }
      }
    });
  }

  updateExperiencesText();
  window.addEventListener('languageChange', updateExperiencesText);
</script>