---
import { getLangFromUrl, useTranslations } from '../i18n/utils';

interface Props {
  slug: string;
  title: string;
  description: string | string[];
  highlights: string[];
  imagePlaceholder: string;
}

const { slug, title, description, highlights, imagePlaceholder } = Astro.props;
const currentLang = getLangFromUrl(Astro.url);
const t = useTranslations(currentLang);

// Convert description to string if it's an array
const descriptionText = Array.isArray(description) ? description.join(' ') : description;

// Construir la URL correcta según el idioma
import { routes, defaultLang, showDefaultLang } from '../i18n/ui';
const experiencesPath = routes[currentLang]?.experiencesPath || routes[defaultLang].experiencesPath;
const langPrefix = (!showDefaultLang && currentLang === defaultLang) ? '' : `/${currentLang}`;
const experienceUrl = `${langPrefix}/${experiencesPath}/${slug}`;

// Convertir imagePlaceholder en array de imágenes (separadas por coma si hay múltiples)
const images = imagePlaceholder.split(',').map(img => img.trim());
const hasMultipleImages = images.length > 1;
const cardId = `card-${slug}`;
---

<div id={cardId} data-card-id={cardId} class="group bg-white rounded-xl overflow-hidden shadow-lg hover:shadow-2xl transition-all duration-300 transform hover:-translate-y-2 flex flex-col h-full">
  <!-- Image Carousel -->
  <div class="relative h-64 overflow-hidden bg-gradient-to-br from-caribbean-blue to-ocean-blue">
    {images[0].startsWith('@/') || images[0].startsWith('/') ? (
      <div class="relative w-full h-full">
        {images.map((img, index) => (
          <img 
            src={img.replace('@/', '/')} 
            alt={`${title} - ${index + 1}`}
            class={`absolute inset-0 w-full h-full object-cover transition-opacity duration-500 image-slide ${index === 0 ? 'opacity-100' : 'opacity-0'}`}
            data-card={cardId}
            data-index={index}
          />
        ))}
        
        {/* Indicadores de imagen */}
        {hasMultipleImages && (
          <div class="absolute bottom-3 left-1/2 -translate-x-1/2 flex gap-2 z-10">
            {images.map((_, index) => (
              <div 
                class={`w-2 h-2 rounded-full transition-all duration-300 image-indicator ${index === 0 ? 'bg-white w-6' : 'bg-white/50'}`}
                data-card={cardId}
                data-index={index}
              />
            ))}
          </div>
        )}
      </div>
    ) : (
      <div class="absolute inset-0 flex items-center justify-center text-white/80 p-6 text-center">
        <p class="text-sm font-medium">{imagePlaceholder}</p>
      </div>
    )}
    <!-- Overlay on hover -->
    <div class="absolute inset-0 bg-coral/0 group-hover:bg-coral/20 transition-all duration-300"></div>
  </div>

  <!-- Card Content -->
  <div class="p-6 flex flex-col flex-1">
    <h3 class="text-2xl font-bold text-gray-900 mb-3 group-hover:text-caribbean-blue transition-colors">
      {title}
    </h3>
    
    <!-- Description -->
    <div class="relative mb-4">
      <!-- Indicador de scroll superior - gradiente fade -->
      <div class="absolute top-0 left-0 right-0 h-8 bg-gradient-to-b from-white to-transparent pointer-events-none scroll-indicator-top opacity-0 z-10"></div>
      
      <div class="h-32 overflow-y-auto pr-2 scrollbar-thin scrollbar-thumb-caribbean-blue/30 scrollbar-track-gray-100 scroll-container">
        <p class="text-gray-700 leading-relaxed text-sm">{descriptionText}</p>
      </div>
      
      <!-- Indicador de scroll inferior - gradiente fade -->
      <div class="absolute bottom-0 left-0 right-0 h-8 bg-gradient-to-t from-white to-transparent pointer-events-none scroll-indicator-bottom"></div>
    </div>

    <!-- Highlights -->
    <div class="relative mb-6">
      <!-- Indicador de scroll superior - gradiente fade -->
      <div class="absolute top-0 left-0 right-0 h-8 bg-gradient-to-b from-white to-transparent pointer-events-none scroll-indicator-top opacity-0 z-10"></div>
      
      <ul class="h-32 overflow-y-auto pr-2 scrollbar-thin scrollbar-thumb-caribbean-blue/30 scrollbar-track-gray-100 scroll-container space-y-2">
        {highlights.map((highlight) => (
          <li class="flex items-start gap-2 text-gray-600">
            <svg class="w-5 h-5 text-tropical-green flex-shrink-0 mt-0.5" fill="currentColor" viewBox="0 0 20 20">
              <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"/>
            </svg>
            <span class="text-sm">{highlight}</span>
          </li>
        ))}
      </ul>
      
      <!-- Indicador de scroll inferior - gradiente fade -->
      <div class="absolute bottom-0 left-0 right-0 h-8 bg-gradient-to-t from-white to-transparent pointer-events-none scroll-indicator-bottom"></div>
    </div>

    <!-- Learn More Button -->
    <a 
      href={experienceUrl}
      class="inline-block w-full text-center px-6 py-3 bg-caribbean-blue text-white rounded-lg font-semibold hover:bg-ocean-blue transition-colors duration-300 mt-auto"
    >
      {t('experienceCard.viewDetails')}
    </a>
  </div>
</div>

<script>
  // Manejar los indicadores de scroll en las tarjetas de experiencias
  function handleScrollIndicators() {
    const scrollContainers = document.querySelectorAll('.scroll-container');
    
    scrollContainers.forEach((container) => {
      const indicatorTop = container.parentElement?.querySelector('.scroll-indicator-top');
      const indicatorBottom = container.parentElement?.querySelector('.scroll-indicator-bottom');
      if (!indicatorTop || !indicatorBottom) return;
      
      // Función para verificar la posición del scroll
      const checkScroll = () => {
        const hasScroll = container.scrollHeight > container.clientHeight;
        const isAtBottom = container.scrollHeight - container.scrollTop <= container.clientHeight + 5;
        
        // Indicador superior: mostrar SOLO cuando estés al final
        if (hasScroll && isAtBottom) {
          indicatorTop.classList.remove('opacity-0');
        } else {
          indicatorTop.classList.add('opacity-0');
        }
        
        // Indicador inferior: mostrar cuando NO estés al final y haya scroll
        if (hasScroll && !isAtBottom) {
          indicatorBottom.classList.remove('opacity-0');
        } else {
          indicatorBottom.classList.add('opacity-0');
        }
      };
      
      // Verificar al cargar
      checkScroll();
      
      // Verificar al hacer scroll
      container.addEventListener('scroll', checkScroll);
      
      // Verificar al cambiar el tamaño de la ventana
      window.addEventListener('resize', checkScroll);
    });
  }
  
  // Inicializar en carga de página
  document.addEventListener('DOMContentLoaded', handleScrollIndicators);
  
  // Reinicializar después de navegación de Astro
  document.addEventListener('astro:page-load', handleScrollIndicators);
  
  // Carrusel automático de imágenes en las tarjetas
  let imageCarouselIntervals: number[] = [];
  
  function cleanupImageCarousels() {
    imageCarouselIntervals.forEach((intervalId) => clearInterval(intervalId));
    imageCarouselIntervals = [];
  }
  
  function initImageCarousels() {
    cleanupImageCarousels();
    const cardElements = document.querySelectorAll('[data-card-id]');
    
    cardElements.forEach((card) => {
      const slides = card.querySelectorAll<HTMLImageElement>('.image-slide');
      const indicators = card.querySelectorAll<HTMLElement>('.image-indicator');
      if (slides.length <= 1) return;
      
      let currentIndex = 0;
      
      const showSlide = (index: number) => {
        slides.forEach((slide, i) => {
          if (i === index) {
            slide.classList.remove('opacity-0');
            slide.classList.add('opacity-100');
          } else {
            slide.classList.remove('opacity-100');
            slide.classList.add('opacity-0');
          }
        });
        
        indicators.forEach((indicator, i) => {
          if (i === index) {
            indicator.classList.add('bg-white', 'w-6');
            indicator.classList.remove('bg-white/50');
          } else {
            indicator.classList.remove('bg-white', 'w-6');
            indicator.classList.add('bg-white/50');
          }
        });
      };
      
      const intervalId = window.setInterval(() => {
        currentIndex = (currentIndex + 1) % slides.length;
        showSlide(currentIndex);
      }, 3000);
      imageCarouselIntervals.push(intervalId);
    });
  }
  
  // Inicializar carruseles de imágenes
  document.addEventListener('DOMContentLoaded', initImageCarousels);
  document.addEventListener('astro:page-load', initImageCarousels);
  document.addEventListener('astro:before-preparation', cleanupImageCarousels);
</script>