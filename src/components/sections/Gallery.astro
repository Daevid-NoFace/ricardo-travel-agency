---
import { getLangFromUrl, useTranslations } from '../i18n/utils';

const currentLang = getLangFromUrl(Astro.url);
const t = useTranslations(currentLang);
const rawGalleryItems = t('gallery.items');
const galleryItems: Array<{ title: string; description: string }> = Array.isArray(rawGalleryItems)
  ? (rawGalleryItems as Array<{ title: string; description: string }>).map((item) => ({
      title: item.title,
      description: item.description
    }))
  : [];

const UNSPLASH_ACCESS_KEY = import.meta.env.UNSPLASH_ACCESS_KEY;

// Cuba-related search queries for each gallery item
const cubaSearchQueries = [
  'havana cuba colorful',
  'classic car cuba',
  'caribbean beach',
  'tobacco field',
  'cuban music',
  'colonial street cuba',
  'havana sunset',
  'cuban food',
  'colonial architecture',
  'tropical beach',
  'salsa dance',
  'valley landscape'
];

// Fetch photos from Unsplash API
const fetchUnsplashPhoto = async (query: string, index: number) => {
  // Fallback colors for placeholders
  const colors = ['FF6B6B', '4ECDC4', '45B7D1', 'FFA07A', '98D8C8', 'F7DC6F', 'BB8FCE', '85C1E2', 'F8B739', 'EC7063', '52B788', 'F4A261'];
  const color = colors[index % colors.length];
  
  // If no API key, use placeholder immediately
  if (!UNSPLASH_ACCESS_KEY) {
    console.warn('No Unsplash API key found, using placeholder');
    return {
      url: `https://placehold.co/800x800/${color}/FFFFFF?text=${encodeURIComponent('Cuba')}`,
      thumb: `https://placehold.co/400x400/${color}/FFFFFF?text=${encodeURIComponent('Cuba')}`,
      alt: query,
      photographer: 'Placeholder',
      photographerUrl: '#'
    };
  }

  try {
    const searchResponse = await fetch(
      `https://api.unsplash.com/search/photos?query=${encodeURIComponent(query)}&per_page=1`,
      {
        headers: {
          'Authorization': `Client-ID ${UNSPLASH_ACCESS_KEY}`
        }
      }
    );

    if (!searchResponse.ok) {
      const errorText = await searchResponse.text();
      console.error(`Unsplash API error for "${query}": ${searchResponse.status} - ${errorText}`);
      throw new Error(`API error: ${searchResponse.status}`);
    }

    const searchData = await searchResponse.json();
    
    if (searchData.results && searchData.results.length > 0) {
      const photo = searchData.results[0];
      console.log(`âœ“ Found photo for "${query}"`);
      return {
        url: photo.urls.regular,
        thumb: photo.urls.small,
        alt: photo.alt_description || query,
        photographer: photo.user.name,
        photographerUrl: photo.user.links.html
      };
    } else {
      console.warn(`No results for "${query}", using placeholder`);
      throw new Error('No photos found');
    }
  } catch (error) {
    // Fallback to placeholder
    return {
      url: `https://placehold.co/800x800/${color}/FFFFFF?text=${encodeURIComponent('Cuba')}`,
      thumb: `https://placehold.co/400x400/${color}/FFFFFF?text=${encodeURIComponent('Cuba')}`,
      alt: query,
      photographer: 'Placeholder',
      photographerUrl: '#'
    };
  }
};

// Fetch all photos
const galleryPhotos = await Promise.all(
  galleryItems.map((item, index) => 
    fetchUnsplashPhoto(cubaSearchQueries[index % cubaSearchQueries.length], index)
  )
);
---

<section id="gallery" class="py-20 bg-white">
  <div class="container mx-auto px-4">
    <!-- Section Header -->
    <div class="text-center mb-16 max-w-3xl mx-auto">
      <span class="text-coral font-semibold text-sm uppercase tracking-wider mb-4 block">{t('gallery.label')}</span>
      <h2 class="text-4xl md:text-5xl font-bold text-gray-900 mb-6">
        {t('gallery.title')} <span class="text-caribbean-blue">{t('gallery.titleHighlight')}</span>
      </h2>
      <p class="text-lg text-gray-700 leading-relaxed">
        {t('gallery.subtitle')}
      </p>
    </div>

    <!-- Gallery Grid -->
    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6 max-w-7xl mx-auto">
      {galleryItems.map((item, index) => {
        const photo = galleryPhotos[index];
        return (
          <div class="group relative overflow-hidden rounded-lg shadow-lg hover:shadow-2xl transition-all duration-300 aspect-square">
            <!-- Image from Unsplash -->
            <img 
              src={photo.url} 
              alt={photo.alt || item.title}
              class="absolute inset-0 w-full h-full object-cover"
              loading="lazy"
              decoding="async"
            />

            <!-- Overlay with hover effect -->
            <div class="absolute inset-0 bg-black/40 group-hover:bg-black/60 transition-all duration-300"></div>
            
            <!-- Content -->
            <div class="absolute inset-0 flex flex-col items-center justify-center p-6 text-center text-white transform group-hover:scale-105 transition-transform duration-300">
              <h3 class="text-lg font-bold mb-2 opacity-0 group-hover:opacity-100 transition-opacity duration-300">
                {item.title}
              </h3>
              <p class="text-sm opacity-0 group-hover:opacity-100 transition-opacity duration-300 delay-75">
                {item.description}
              </p>
            </div>

            <!-- Zoom icon on hover -->
            <div class="absolute top-4 right-4 opacity-0 group-hover:opacity-100 transition-opacity duration-300">
              <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0zM10 7v6m3-3H7"/>
              </svg>
            </div>

            <!-- Photo credit -->
            {photo.photographer !== 'Placeholder' && (
              <div class="absolute bottom-2 left-2 opacity-0 group-hover:opacity-100 transition-opacity duration-300">
                <a 
                  href={photo.photographerUrl} 
                  target="_blank" 
                  rel="noopener noreferrer"
                  class="text-xs text-white/80 hover:text-white"
                >
                  ðŸ“· {photo.photographer}
                </a>
              </div>
            )}
          </div>
        );
      })}
    </div>

    <!-- Gallery Note -->
    <div class="text-center mt-12">
      <p class="text-gray-600 italic">
        {t('gallery.note')}
      </p>
    </div>
  </div>
</section>